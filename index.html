<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Protokol Data Bluetooth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .data-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
        }
        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 10px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        .status-connected { background-color: #10b981; color: white; }
        .status-disconnected { background-color: #f87171; color: white; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-500 pb-2">
            Dashboard Protokol Data Bluetooth
        </h1>

        <!-- Kontrol Koneksi -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between">
            <div class="flex items-center space-x-3 mb-4 sm:mb-0">
                <div id="statusIndicator" class="w-4 h-4 rounded-full status-disconnected animate-pulse"></div>
                <span id="connectionStatus" class="font-semibold text-gray-700">Terputus</span>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <button id="connectButton" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                    <i class="fas fa-bluetooth-b mr-2"></i> Scan & Connect
                </button>
                <button id="sendButton" class="px-4 py-2 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600 transition duration-150 shadow-md disabled:opacity-50" disabled>
                    Kirim "R"
                </button>
            </div>
        </div>

        <!-- Area Pesan/Log -->
        <div id="messageBox" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-6 hidden" role="alert">
            <p id="messageText" class="font-medium"></p>
        </div>

        <!-- Dashboard Data -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4" id="dataDashboard">
            <!-- Data Cards akan di-generate di sini oleh JavaScript -->
        </div>
        
        <!-- Petunjuk Protokol -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Info Protokol yang Digunakan</h3>
            <ul class="list-disc list-inside text-sm text-gray-600 bg-gray-100 p-4 rounded-lg">
                <li>**Total Paket:** 66 byte.</li>
                <li>**Start Byte:** 0xAA (1 byte).</li>
                <li>**Payload Data:** 16 variabel @ 4-byte Float (32-bit, Little-Endian) = 64 byte.</li>
                <li>**End Byte:** 1-byte Checksum (XOR dari 64 byte payload).</li>
            </ul>
        </div>
    </div>

    <script>
        // --- KONFIGURASI BLUETOOTH (Web Bluetooth / BLE) ---
        // Catatan: Browser modern hanya mendukung BLE, bukan Bluetooth Classic Serial.
        // Kami menggunakan UUID Nordic UART Service (NUS) sebagai proxy serial.
        // UBAH UUID INI JIKA PERANGKAT ANDA MENGGUNAKAN UUID KUSTOM!
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e'; // NUS Service
        const TX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // Write/Send Command ('R')
        const RX_CHAR_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // Notify/Receive Data

        let device, rxCharacteristic, txCharacteristic;

        // --- DOM ELEMENTS ---
        const connectButton = document.getElementById('connectButton');
        const sendButton = document.getElementById('sendButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionStatus = document.getElementById('connectionStatus');
        const dataDashboard = document.getElementById('dataDashboard');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Initialize dashboard with 16 placeholder variables
        const initialData = Array(16).fill("N/A");
        renderDashboard(initialData);

        // --- UTILITY FUNCTIONS ---

        /**
         * Menampilkan pesan error atau status.
         * @param {string} msg 
         * @param {boolean} isError 
         */
        function showMessage(msg, isError = true) {
            messageText.textContent = msg;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-700', 'text-green-700');
            if (isError) {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        /**
         * Mengupdate status koneksi di UI.
         * @param {boolean} connected 
         */
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.textContent = "Tersambung";
                statusIndicator.classList.remove('status-disconnected', 'animate-pulse');
                statusIndicator.classList.add('status-connected');
                sendButton.disabled = false;
            } else {
                connectionStatus.textContent = "Terputus";
                statusIndicator.classList.remove('status-connected');
                statusIndicator.classList.add('status-disconnected', 'animate-pulse');
                sendButton.disabled = true;
            }
        }

        /**
         * Menggambar ulang dashboard data.
         * @param {string[]} dataArray Array of 16 formatted string values
         */
        function renderDashboard(dataArray) {
            dataDashboard.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const index = i + 1;
                const card = `
                    <div id="var${index}" class="data-card p-4 rounded-xl border border-gray-200">
                        <p class="text-xs font-medium text-indigo-500">Variabel #${index}</p>
                        <p class="text-2xl font-bold text-gray-800 mt-1">${dataArray[i]}</p>
                        <p class="text-xs text-gray-500 mt-1">Float (32-bit)</p>
                    </div>
                `;
                dataDashboard.innerHTML += card;
            }
        }


        // --- LOGIKA PARSING PROTOKOL BINARY ---

        /**
         * Memproses paket data 66 byte sesuai protokol.
         * @param {DataView} dataView Raw data received from Bluetooth device.
         * @returns {string[]} Array of 16 formatted float strings.
         */
        function parseBluetoothProtocol(dataView) {
            const buffer = dataView.buffer;
            
            if (buffer.byteLength !== 66) {
                throw new Error("Panjang paket tidak sesuai (66 byte diharapkan). Diterima: " + buffer.byteLength);
            }

            // 1. Periksa Start Byte (0xAA)
            const startByte = dataView.getUint8(0);
            if (startByte !== 0xAA) {
                throw new Error(`Start byte tidak valid. Diterima: 0x${startByte.toString(16).toUpperCase()}, Diharapkan: 0xAA`);
            }

            // 2. Verifikasi Checksum (XOR dari 64 byte data)
            let calculatedChecksum = 0;
            // Loop dari byte data pertama (index 1) sampai byte data terakhir (index 64)
            for (let i = 1; i <= 64; i++) {
                calculatedChecksum ^= dataView.getUint8(i);
            }
            const receivedChecksum = dataView.getUint8(65); // Checksum ada di byte terakhir (index 65)

            if (calculatedChecksum !== receivedChecksum) {
                throw new Error(`Checksum tidak cocok. Diterima: ${receivedChecksum}, Dihitung: ${calculatedChecksum}`);
            }

            // 3. Ekstraksi 16 Float (Little-Endian)
            const variables = [];
            // Loop 16 kali
            for (let i = 0; i < 16; i++) {
                // Offset dimulai dari byte 1 (setelah Start Byte)
                const offset = 1 + i * 4;
                // getFloat32(byteOffset, littleEndian)
                const floatValue = dataView.getFloat32(offset, true); // true = Little-Endian
                variables.push(floatValue.toFixed(4)); // Format hingga 4 angka desimal
            }

            showMessage("Data Diterima & Protokol Valid. Checksum OK.", false);
            return variables;
        }


        // --- BLUETOOTH EVENT HANDLERS ---

        /**
         * Dipanggil ketika ada data baru diterima dari RX Characteristic (Notify).
         * @param {Event} event 
         */
        function handleNotifications(event) {
            const value = event.target.value;
            try {
                const dataArray = parseBluetoothProtocol(value);
                renderDashboard(dataArray);
            } catch (error) {
                console.error("Kesalahan Parsing Data:", error.message);
                showMessage("Kesalahan Data: " + error.message, true);
            }
        }

        /**
         * Dipanggil ketika perangkat Bluetooth terputus.
         * @param {Event} event 
         */
        function onDisconnected(event) {
            console.log('Perangkat terputus:', event.target.name);
            showMessage(`Terputus dari perangkat: ${event.target.name}`, true);
            updateConnectionStatus(false);
            device = null;
        }

        // --- BLUETOOTH API LOGIC ---

        /**
         * Memulai proses Scan & Connect.
         */
        async function connectDevice() {
            if (!navigator.bluetooth) {
                showMessage("Browser Anda tidak mendukung Web Bluetooth. Pastikan menggunakan Chrome/Edge di desktop atau Android.", true);
                return;
            }

            try {
                showMessage("Scanning...", false);
                
                // 1. Pilih Perangkat
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [SERVICE_UUID] }],
                    optionalServices: [SERVICE_UUID]
                });
                
                device.addEventListener('gattserverdisconnected', onDisconnected);
                showMessage(`Terdeteksi: ${device.name}. Menghubungkan...`, false);

                // 2. Hubungkan ke Server GATT
                const server = await device.gatt.connect();
                showMessage("Tersambung ke Server GATT. Mencari Layanan...", false);

                // 3. Dapatkan Layanan (Service)
                const service = await server.getPrimaryService(SERVICE_UUID);
                showMessage("Layanan Ditemukan. Mencari Karakteristik...", false);

                // 4. Dapatkan Karakteristik TX (untuk kirim) dan RX (untuk terima)
                txCharacteristic = await service.getCharacteristic(TX_CHAR_UUID);
                rxCharacteristic = await service.getCharacteristic(RX_CHAR_UUID);
                
                // 5. Setup Notifikasi (Untuk Menerima Data)
                await rxCharacteristic.startNotifications();
                rxCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                showMessage(`Koneksi Berhasil! Tersambung ke ${device.name}.`, false);
                updateConnectionStatus(true);
            
            } catch (error) {
                console.error('Koneksi Gagal:', error);
                
                let errorMessage = `Koneksi Gagal: ${error.name || error.message}. Pastikan BLE aktif.`;
                
                // Penanganan Spesifik untuk Error Security (karena dijalankan di iframe)
                if (error.name === 'SecurityError' && error.message.includes('disallowed by permissions policy')) {
                    errorMessage = "GAGAL: Fitur Bluetooth diblokir oleh kebijakan keamanan browser (Permissions Policy). Ini sering terjadi saat menjalankan aplikasi di dalam bingkai (iframe). Mohon coba jalankan kode ini di jendela browser penuh (standalone) atau cek pengaturan izin browser Anda.";
                }

                showMessage(errorMessage, true);
                updateConnectionStatus(false);
            }
        }

        /**
         * Mengirimkan string "R" ke perangkat.
         */
        async function sendCommandR() {
            if (!txCharacteristic) {
                showMessage("Belum terhubung atau Karakteristik TX tidak ditemukan.", true);
                return;
            }

            try {
                // Konversi string "R" menjadi ArrayBuffer (Byte)
                const command = new TextEncoder().encode("R");
                
                // Tulis ke Karakteristik TX
                await txCharacteristic.writeValue(command);
                showMessage('Perintah "R" berhasil dikirim.', false);
            } catch (error) {
                console.error('Gagal mengirim perintah:', error);
                showMessage(`Gagal mengirim "R": ${error.message}`, true);
            }
        }


        // --- EVENT LISTENERS ---
        connectButton.addEventListener('click', connectDevice);
        sendButton.addEventListener('click', sendCommandR);

        // Pastikan UI status awal benar
        updateConnectionStatus(false);
    </script>
</body>
</html>