&lt;!DOCTYPE html&gt;<br/>&lt;html lang=&quot;id&quot;&gt;<br/>&lt;head&gt;<br/>    &lt;meta charset=&quot;UTF-8&quot;&gt;<br/>    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;<br/>    &lt;title&gt;Dashboard Monitor Data Bluetooth BMS&lt;/title&gt;<br/>    &lt;!-- Memuat Tailwind CSS untuk styling --&gt;<br/>    &lt;script src=&quot;https://cdn.tailwindcss.com&quot;&gt;&lt;/script&gt;<br/>    &lt;style&gt;<br/>        /* Menggunakan font Inter */<br/>        html { font-family: &#39;Inter&#39;, sans-serif; }<br/>        .dashboard-grid {<br/>            /* Membuat grid responsif, minimal 280px per kolom */<br/>            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));<br/>        }<br/>    &lt;/style&gt;<br/>&lt;/head&gt;<br/>&lt;body class=&quot;bg-gray-50 min-h-screen p-4 md:p-8&quot;&gt;<br/>    &lt;script&gt;<br/>        // Konfigurasi Tailwind untuk tema<br/>        tailwind.config = {<br/>            theme: {<br/>                extend: {<br/>                    colors: {<br/>                        &#39;primary&#39;: &#39;#10b981&#39;, // emerald<br/>                        &#39;secondary&#39;: &#39;#3b82f6&#39;, // blue<br/>                    }<br/>                }<br/>            }<br/>        }<br/>    &lt;/script&gt;<br/>    &lt;div class=&quot;max-w-4xl mx-auto&quot;&gt;<br/>        &lt;header class=&quot;text-center mb-8&quot;&gt;<br/>            &lt;h1 class=&quot;text-4xl font-extrabold text-gray-800 mb-2&quot;&gt;Monitor Data BMS Bluetooth&lt;/h1&gt;<br/>            &lt;p id=&quot;status-message&quot; class=&quot;text-lg text-gray-600&quot;&gt;Tekan &#39;Sambungkan&#39; untuk memulai pemindaian.&lt;/p&gt;<br/>        &lt;/header&gt;<div></div>        &lt;!-- Bagian Kontrol Bluetooth --&gt;<br/>        &lt;section class=&quot;bg-white p-6 rounded-xl shadow-lg mb-8 flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-4&quot;&gt;<br/>            &lt;button id=&quot;connect-button&quot; onclick=&quot;connectBluetooth()&quot; class=&quot;w-full md:w-auto px-6 py-3 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 transition duration-300 disabled:opacity-50&quot;&gt;<br/>                &lt;i class=&quot;fas fa-bluetooth-b mr-2&quot;&gt;&lt;/i&gt; Sambungkan Perangkat<br/>            &lt;/button&gt;<br/>            &lt;button id=&quot;disconnect-button&quot; onclick=&quot;disconnectBluetooth()&quot; class=&quot;w-full md:w-auto px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300 disabled:opacity-50&quot; disabled&gt;<br/>                Putuskan Koneksi<br/>            &lt;/button&gt;<br/>            &lt;p id=&quot;device-info&quot; class=&quot;text-sm text-gray-500 mt-2 md:mt-0&quot;&gt;&lt;/p&gt;<br/>        &lt;/section&gt;<div></div>        &lt;!-- Dashboard Data --&gt;<br/>        &lt;section class=&quot;bg-white p-6 rounded-xl shadow-lg&quot;&gt;<br/>            &lt;h2 class=&quot;text-2xl font-bold text-gray-800 mb-4 border-b pb-2&quot;&gt;Data Real-Time&lt;/h2&gt;<br/>            &lt;div id=&quot;data-dashboard&quot; class=&quot;grid dashboard-grid gap-4&quot;&gt;<br/>                &lt;!-- Data akan diinjeksikan di sini oleh JavaScript --&gt;<br/>            &lt;/div&gt;<br/>            &lt;div id=&quot;error-box&quot; class=&quot;mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden&quot;&gt;<br/>                &lt;p class=&quot;font-bold&quot;&gt;Kesalahan Parsing Data:&lt;/p&gt;<br/>                &lt;p id=&quot;error-details&quot; class=&quot;text-sm&quot;&gt;&lt;/p&gt;<br/>            &lt;/div&gt;<br/>        &lt;/section&gt;<br/>    &lt;/div&gt;<div></div>    &lt;!-- Font Awesome Icons (Digunakan untuk ikon koneksi) --&gt;<br/>    &lt;script src=&quot;https://kit.fontawesome.com/a076d05399.js&quot; crossorigin=&quot;anonymous&quot;&gt;&lt;/script&gt;<div></div>    &lt;script&gt;<br/>        // --- Variabel Global &amp; Konstanta ---<br/>        let device = null;<br/>        let rxCharacteristic = null; // Characteristic for Receiving Data (Notifications)<br/>        let txCharacteristic = null; // Characteristic for Sending Data (Writing)<br/>        let requestInterval = null;<br/>        // Standard UUIDs for Nordic UART Service (NUS)<br/>        const UART_SERVICE_UUID = &#39;6e400001-b5a3-f393-e0a9-e50e24dcca9e&#39;;<br/>        const TX_CHARACTERISTIC_UUID = &#39;6e400002-b5a3-f393-e0a9-e50e24dcca9e&#39;; // Write &#39;R&#39; command here<br/>        const RX_CHARACTERISTIC_UUID = &#39;6e400003-b5a3-f393-e0a9-e50e24dcca9e&#39;; // Receive data from here<br/>        <br/>        // Data structure definition (16 x 4-byte float)<br/>        const DATA_MAP = [<br/>            { label: &#39;Tegangan Sel 1&#39;, unit: &#39;V&#39;, icon: &#39;üîã&#39; },<br/>            { label: &#39;Tegangan Sel 2&#39;, unit: &#39;V&#39;, icon: &#39;üîã&#39; },<br/>            { label: &#39;Tegangan Sel 3&#39;, unit: &#39;V&#39;, icon: &#39;üîã&#39; },<br/>            { label: &#39;Tegangan Sel 4&#39;, unit: &#39;V&#39;, icon: &#39;üîã&#39; },<br/>            { label: &#39;Tegangan Sel 5&#39;, unit: &#39;V&#39;, icon: &#39;üîã&#39; },<br/>            { label: &#39;Arus&#39;, unit: &#39;A&#39;, icon: &#39;‚ö°&#39; },<br/>            { label: &#39;Daya&#39;, unit: &#39;W&#39;, icon: &#39;‚öôÔ∏è&#39; },<br/>            { label: &#39;Kapasitas Terpakai&#39;, unit: &#39;Ah&#39;, icon: &#39;üîÑ&#39; },<br/>            { label: &#39;SOC (State of Charge)&#39;, unit: &#39;%&#39;, icon: &#39;üìä&#39; },<br/>            { label: &#39;Suhu 1&#39;, unit: &#39;¬∞C&#39;, icon: &#39;üå°Ô∏è&#39; },<br/>            { label: &#39;Suhu 2&#39;, unit: &#39;¬∞C&#39;, icon: &#39;üå°Ô∏è&#39; },<br/>            { label: &#39;Kapasitas Tersisa&#39;, unit: &#39;Ah&#39;, icon: &#39;üíæ&#39; },<br/>            { label: &#39;Kesehatan % 1&#39;, unit: &#39;%&#39;, icon: &#39;üíπ&#39; },<br/>            { label: &#39;Kesehatan % 2&#39;, unit: &#39;%&#39;, icon: &#39;üíπ&#39; },<br/>            { label: &#39;Status Pengisi Daya&#39;, unit: &#39;&#39;, icon: &#39;üîå&#39; },<br/>            { label: &#39;Status Penguras Daya&#39;, unit: &#39;&#39;, icon: &#39;üî•&#39; },<br/>        ];<div></div>        // --- UI Elements ---<br/>        const statusMessage = document.getElementById(&#39;status-message&#39;);<br/>        const connectButton = document.getElementById(&#39;connect-button&#39;);<br/>        const disconnectButton = document.getElementById(&#39;disconnect-button&#39;);<br/>        const dataDashboard = document.getElementById(&#39;data-dashboard&#39;);<br/>        const deviceInfo = document.getElementById(&#39;device-info&#39;);<br/>        const errorBox = document.getElementById(&#39;error-box&#39;);<br/>        const errorDetails = document.getElementById(&#39;error-details&#39;);<div></div><br/>        // --- Utility Functions ---<div></div>        /**<br/>         * Calculates the XOR checksum of the data payload.<br/>         * Checksum = XOR of all data bytes (excluding Start Byte and Checksum itself).<br/>         * @param {DataView} dataView - The DataView object of the packet.<br/>         * @returns {number} The calculated checksum value.<br/>         */<br/>        function calculateChecksum(dataView) {<br/>            let checksum = 0;<br/>            // XOR bytes 1 through 64 (the 64-byte float data payload)<br/>            for (let i = 1; i &lt;= 64; i++) {<br/>                checksum ^= dataView.getUint8(i);<br/>            }<br/>            return checksum;<br/>        }<div></div>        /**<br/>         * Parses the raw data packet, validates start byte and checksum,<br/>         * and extracts the 16 float values.<br/>         * @param {DataView} dataView - The DataView containing the 66-byte packet.<br/>         * @returns {Array&lt;number&gt;|null} Array of 16 float values, or null on failure.<br/>         */<br/>        function parseData(dataView) {<br/>            // Expected packet size: 1 (Start) + 64 (Data: 16 * 4 float) + 1 (Checksum) = 66 bytes<br/>            const EXPECTED_LENGTH = 66;<br/>            if (dataView.byteLength !== EXPECTED_LENGTH) {<br/>                const msg = `Panjang paket salah: ${dataView.byteLength} byte (diharapkan ${EXPECTED_LENGTH} byte).`;<br/>                console.error(msg);<br/>                errorDetails.textContent = msg;<br/>                errorBox.classList.remove(&#39;hidden&#39;);<br/>                return null;<br/>            }<div></div>            // 1. Validate Start Byte (0xAA)<br/>            const START_BYTE_OFFSET = 0;<br/>            const EXPECTED_START_BYTE = 0xAA;<br/>            const startByte = dataView.getUint8(START_BYTE_OFFSET);<div></div>            if (startByte !== EXPECTED_START_BYTE) {<br/>                const msg = `Start Byte salah: 0x${startByte.toString(16)} (diharapkan 0x${EXPECTED_START_BYTE.toString(16)}).`;<br/>                console.error(msg);<br/>                errorDetails.textContent = msg;<br/>                errorBox.classList.remove(&#39;hidden&#39;);<br/>                return null;<br/>            }<div></div>            // 2. Validate Checksum (Last byte)<br/>            const CHECKSUM_OFFSET = 65;<br/>            const receivedChecksum = dataView.getUint8(CHECKSUM_OFFSET);<br/>            const calculatedChecksum = calculateChecksum(dataView);<div></div>            if (receivedChecksum !== calculatedChecksum) {<br/>                const msg = `Checksum salah. Diterima: 0x${receivedChecksum.toString(16)}, Dihitung: 0x${calculatedChecksum.toString(16)}. Data mungkin korup.`;<br/>                console.error(msg);<br/>                errorDetails.textContent = msg;<br/>                errorBox.classList.remove(&#39;hidden&#39;);<br/>                return null;<br/>            }<div></div>            // Checksum is OK, parsing 16 floats (32-bit, Little Endian)<br/>            const values = [];<br/>            let offset = 1; // Start at byte 1, after the Start Byte<div></div>            for (let i = 0; i &lt; 16; i++) {<br/>                // TRUE means Little-Endian<br/>                const floatValue = dataView.getFloat32(offset, true);<br/>                values.push(floatValue);<br/>                offset += 4; // Advance 4 bytes<br/>            }<br/>            <br/>            errorBox.classList.add(&#39;hidden&#39;); // Hide error message if parsing succeeded<br/>            return values;<br/>        }<div></div>        /**<br/>         * Sends the &#39;R&#39; command (Request Data) to the Bluetooth device.<br/>         */<br/>        async function sendRequest() {<br/>            if (!txCharacteristic) {<br/>                // console.error(&quot;TX Characteristic not ready.&quot;);<br/>                return;<br/>            }<br/>            try {<br/>                // Create buffer from the character &#39;R&#39;<br/>                const value = new TextEncoder().encode(&quot;R&quot;);<br/>                await txCharacteristic.writeValue(value);<br/>                // console.log(&quot;Command &#39;R&#39; sent.&quot;);<br/>            } catch (error) {<br/>                console.error(&quot;Failed to send &#39;R&#39; command:&quot;, error);<br/>                statusMessage.textContent = &quot;Gagal mengirim data. Coba sambungkan ulang.&quot;;<br/>                // Clear interval if transmission error occurs<br/>                if (requestInterval) {<br/>                    clearInterval(requestInterval);<br/>                }<br/>            }<br/>        }<div></div>        /**<br/>         * Handler when the RX characteristic (receiving data) changes (notification).<br/>         * @param {Event} event - Event from Web Bluetooth.<br/>         */<br/>        function handleNotifications(event) {<br/>            const value = event.target.value;<br/>            const dataView = new DataView(value.buffer);<br/>            <br/>            const parsedValues = parseData(dataView);<div></div>            if (parsedValues) {<br/>                updateDashboard(parsedValues);<br/>            }<br/>        }<div></div>        /**<br/>         * Initializes the dashboard and displays the data values.<br/>         * @param {Array&lt;number&gt;} values - Array of 16 float values.<br/>         */<br/>        function updateDashboard(values) {<br/>            let html = &#39;&#39;;<div></div>            values.forEach((value, index) =&gt; {<br/>                const dataInfo = DATA_MAP[index];<br/>                let formattedValue = value.toFixed(3); // Default 3 decimals<br/>                let displayUnit = dataInfo.unit;<br/>                let bgColor = &#39;bg-blue-50&#39;; // Default background<div></div>                // Display adjustments based on data type<br/>                if (dataInfo.label.includes(&#39;Tegangan&#39;)) {<br/>                    bgColor = &#39;bg-yellow-50&#39;;<br/>                } else if (dataInfo.label.includes(&#39;Suhu&#39;)) {<br/>                    bgColor = &#39;bg-red-50&#39;;<br/>                } else if (dataInfo.label.includes(&#39;SOC&#39;) || dataInfo.label.includes(&#39;Kesehatan&#39;)) {<br/>                    formattedValue = value.toFixed(2);<br/>                    bgColor = &#39;bg-green-50&#39;;<br/>                } else if (dataInfo.label.includes(&#39;Status&#39;)) {<br/>                    formattedValue = (value === 1.0) ? &#39;AKTIF&#39; : &#39;IDLE&#39;;<br/>                    displayUnit = &#39;&#39;;<br/>                    bgColor = (value === 1.0) ? &#39;bg-primary/20&#39; : &#39;bg-gray-100&#39;;<br/>                }<div></div>                html += `<br/>                    &lt;div class=&quot;p-4 ${bgColor} rounded-lg shadow-sm border border-gray-200&quot;&gt;<br/>                        &lt;div class=&quot;flex items-center space-x-2 mb-1&quot;&gt;<br/>                            &lt;span class=&quot;text-xl&quot;&gt;${dataInfo.icon}&lt;/span&gt;<br/>                            &lt;p class=&quot;text-sm font-medium text-gray-500&quot;&gt;${dataInfo.label}&lt;/p&gt;<br/>                        &lt;/div&gt;<br/>                        &lt;p class=&quot;text-2xl font-semibold text-gray-800&quot;&gt;<br/>                            ${formattedValue} &lt;span class=&quot;text-lg font-normal text-gray-600&quot;&gt;${displayUnit}&lt;/span&gt;<br/>                        &lt;/p&gt;<br/>                    &lt;/div&gt;<br/>                `;<br/>            });<div></div>            dataDashboard.innerHTML = html;<br/>        }<div></div>        /**<br/>         * Main function to connect to the Bluetooth device.<br/>         */<br/>        async function connectBluetooth() {<br/>            if (!navigator.bluetooth) {<br/>                statusMessage.textContent = &quot;Web Bluetooth tidak didukung di browser ini. Gunakan Chrome melalui HTTPS/localhost.&quot;;<br/>                return;<br/>            }<div></div>            connectButton.disabled = true;<br/>            statusMessage.textContent = &quot;Memindai perangkat...&quot;;<div></div>            try {<br/>                // 1. Request Device<br/>                device = await navigator.bluetooth.requestDevice({<br/>                    filters: [{ services: [UART_SERVICE_UUID] }],<br/>                    optionalServices: []<br/>                });<div></div>                device.addEventListener(&#39;gattserverdisconnected&#39;, onDisconnected);<br/>                deviceInfo.textContent = `Perangkat: ${device.name || &#39;Tidak Dikenal&#39;}`;<br/>                statusMessage.textContent = `Menyambung ke ${device.name || &#39;perangkat tak dikenal&#39;}...`;<div></div>                // 2. Connect to GATT Server<br/>                const server = await device.gatt.connect();<br/>                statusMessage.textContent = &quot;Tersambung. Mencari Layanan UART...&quot;;<div></div>                // 3. Get UART Service<br/>                const service = await server.getPrimaryService(UART_SERVICE_UUID);<br/>                statusMessage.textContent = &quot;Layanan UART ditemukan. Mencari Karakteristik...&quot;;<div></div>                // 4. Get RX and TX Characteristics<br/>                rxCharacteristic = await service.getCharacteristic(RX_CHARACTERISTIC_UUID);<br/>                txCharacteristic = await service.getCharacteristic(TX_CHARACTERISTIC_UUID);<br/>                statusMessage.textContent = &quot;Karakteristik ditemukan. Memulai notifikasi data...&quot;;<div></div>                // 5. Enable RX Notifications and Add Listener<br/>                await rxCharacteristic.startNotifications();<br/>                rxCharacteristic.addEventListener(&#39;characteristicvaluechanged&#39;, handleNotifications);<br/>                <br/>                statusMessage.textContent = &quot;Dashboard siap! Data diperbarui setiap detik.&quot;;<br/>                connectButton.disabled = true;<br/>                disconnectButton.disabled = false;<div></div>                // 6. Start sending the &#39;R&#39; command every 1000ms (1 second)<br/>                requestInterval = setInterval(sendRequest, 1000);<div></div>            } catch (error) {<br/>                const msg = &quot;Gagal menyambung atau inisialisasi Bluetooth: &quot; + error.message;<br/>                console.error(msg, error);<br/>                statusMessage.textContent = msg;<br/>                connectButton.disabled = false;<br/>                disconnectButton.disabled = true;<br/>                deviceInfo.textContent = &quot;&quot;;<br/>                if (requestInterval) {<br/>                    clearInterval(requestInterval);<br/>                    requestInterval = null;<br/>                }<br/>            }<br/>        }<div></div>        /**<br/>         * Disconnects the Bluetooth connection.<br/>         */<br/>        function disconnectBluetooth() {<br/>            if (device &amp;&amp; device.gatt.connected) {<br/>                device.gatt.disconnect();<br/>            } else {<br/>                onDisconnected(); // Update UI even if already disconnected<br/>            }<br/>        }<div></div>        /**<br/>         * Handler when the Bluetooth connection is lost.<br/>         */<br/>        function onDisconnected() {<br/>            if (requestInterval) {<br/>                clearInterval(requestInterval);<br/>                requestInterval = null;<br/>            }<br/>            if (rxCharacteristic) {<br/>                rxCharacteristic.removeEventListener(&#39;characteristicvaluechanged&#39;, handleNotifications);<br/>            }<br/>            statusMessage.textContent = &quot;Koneksi Bluetooth terputus.&quot;;<br/>            deviceInfo.textContent = &quot;&quot;;<br/>            connectButton.disabled = false;<br/>            disconnectButton.disabled = true;<br/>        }<div></div>        // Initialize dashboard display with 0.000 values<br/>        document.addEventListener(&#39;DOMContentLoaded&#39;, () =&gt; {<br/>            const initialValues = Array(16).fill(0.0);<br/>            updateDashboard(initialValues);<br/>        });<br/>    &lt;/script&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;